<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputation: Manual Ledger</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --success: #28a745; --danger: #dc3545; --warning: #ffc107; --primary: #007bff; --gold: #ffd700; }
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background: #f0f2f5; color: #1a1a1a; }
        #auth-screen { background: white; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 50px;}
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .auth-btn { background: #000; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        #app-ui { display: none; }
        
        .dashboard { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; text-align: center; border-bottom: 5px solid #ddd; position: relative; }
        .global-score { font-size: 3.2rem; font-weight: 900; margin: 5px 0; line-height: 1; }
        .label { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 5px; display: block; }
        
        .bar-bg { width: 100%; height: 8px; background: #eee; border-radius: 4px; overflow: hidden; margin: 8px 0; }
        #medalProgressBar { height: 100%; background: var(--gold); width: 0%; transition: width 0.6s ease; }

        /* Ledger Navigation */
        .calendar-nav { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; }
        #viewDateSelector { border: none; font-weight: bold; font-size: 16px; font-family: inherit; cursor: pointer; }
        
        /* Task List */
        ul { list-style: none; padding: 0; }
        li { background: #fff; margin-bottom: 12px; padding: 14px; border-radius: 16px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; border-left: 6px solid #ccc; }
        li.state-done { border-left-color: var(--success); background: #fafffb; }
        li.state-failed { border-left-color: var(--danger); background: #fff5f5; opacity: 0.8; }
        li.state-done .task-text { text-decoration: line-through; opacity: 0.6; }

        /* Tri-State Control */
        .status-box { width: 34px; height: 34px; border-radius: 8px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 12px; font-size: 18px; font-weight: bold; transition: 0.2s; background: white; }
        .status-box.done { background: var(--success); border-color: var(--success); color: white; }
        .status-box.failed { background: var(--danger); border-color: var(--danger); color: white; }
        
        .task-text { flex: 1; font-weight: 600; font-size: 16px; }
        .badge { font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; margin-left: 5px; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <input type="email" id="email" class="auth-input" placeholder="Email">
        <input type="password" id="password" class="auth-input" placeholder="Password">
        <button onclick="handleAuth('login')" class="auth-btn">Login</button>
    </div>

    <div id="app-ui">
        <div class="dashboard">
            <span class="label">Reputation Ledger</span>
            <div class="global-score" id="globalScore">0.0</div>
            <div class="bar-bg"><div id="medalProgressBar"></div></div>
        </div>

        <div class="calendar-nav">
            <button onclick="changeViewDate(-1)">â—€</button>
            <input type="date" id="viewDateSelector" onchange="render()">
            <button onclick="changeViewDate(1)">â–¶</button>
        </div>

        <div style="background: white; padding: 15px; border-radius: 16px; margin-bottom: 20px;">
            <input type="text" id="taskInput" placeholder="New mission..." style="width: 100%; padding: 10px; border: 1px solid #eee; border-radius: 8px;">
            <div style="margin-top: 10px; display: flex; align-items: center; gap: 10px;">
                <label style="font-size: 12px;"><input type="checkbox" id="dailyInput"> DAILY</label>
                <button onclick="addTask()" style="margin-left: auto; background: black; color: white; border: none; padding: 8px 15px; border-radius: 8px;">ADD</button>
            </div>
        </div>

        <span class="label">Missions</span>
        <ul id="taskList"></ul>

        <span class="label">Holding Pen</span>
        <ul id="holdingPen"></ul>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBVKXdqta9WYvdz8g3j0ZKd_HYM-R1EJdo",
            authDomain: "do-it-685b9.firebaseapp.com",
            projectId: "do-it-685b9",
            storageBucket: "do-it-685b9.firebasestorage.app",
            messagingSenderId: "344979931866",
            appId: "1:344979931866:web:0b2e5cd04e883f33cfdbe3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let tasks = [], userId = null;
        const getToday = () => new Date().toISOString().split('T')[0];
        document.getElementById('viewDateSelector').value = getToday();

        auth.onAuthStateChanged(async (user) => {
            if (user) { userId = user.uid; document.getElementById('auth-screen').style.display = 'none'; document.getElementById('app-ui').style.display = 'block'; await syncWithCloud(); }
        });

        async function handleAuth(t) {
            const e = document.getElementById('email').value, p = document.getElementById('password').value;
            await auth.signInWithEmailAndPassword(e, p);
        }

        async function syncWithCloud() {
            const doc = await db.collection('users').doc(userId).get();
            if (doc.exists) { tasks = doc.data().tasks || []; }
            render();
        }

        function changeViewDate(d) {
            const curr = new Date(document.getElementById('viewDateSelector').value);
            curr.setDate(curr.getDate() + d);
            document.getElementById('viewDateSelector').value = curr.toISOString().split('T')[0];
            render();
        }

        async function addTask() {
            const input = document.getElementById('taskInput'), daily = document.getElementById('dailyInput');
            tasks.push({
                id: Date.now(), text: input.value, date: document.getElementById('viewDateSelector').value,
                isDaily: daily.checked, 
                log: {} // Log will store { "2024-02-01": "DONE", "2024-02-02": "FAIL" }
            });
            input.value = ''; render(); await db.collection('users').doc(userId).set({ tasks }, { merge: true });
        }

        // --- THE LEDGER ENGINE ---
        // This calculates the score and streak based on the entire history every time
        function calculateStats(t) {
            let score = 0;
            let currentStreak = 0;
            const dates = Object.keys(t.log || {}).sort();
            
            dates.forEach(date => {
                const status = t.log[date];
                if (status === 'DONE') {
                    score += 1;
                    currentStreak++;
                } else if (status === 'FAIL') {
                    // Apply your harsh penalty rules
                    let penalty = currentStreak >= 30 ? 20 : (currentStreak >= 10 ? 5 : 1);
                    score -= penalty;
                    currentStreak = 0;

                    // Check Major Consistency Penalty (-10)
                    const idx = dates.indexOf(date);
                    if (idx > 0) {
                        const prevDate = dates[idx-1];
                        const diff = Math.ceil(Math.abs(new Date(date) - new Date(prevDate)) / 86400000);
                        if (diff === 1 && t.log[prevDate] === 'FAIL') score -= 10;
                    }
                }
            });
            return { score, currentStreak };
        }

        async function cycleStatus(id) {
            const date = document.getElementById('viewDateSelector').value;
            tasks = tasks.map(t => {
                if (t.id === id) {
                    if (!t.log) t.log = {};
                    const current = t.log[date];
                    if (!current) t.log[date] = 'DONE';
                    else if (current === 'DONE') t.log[date] = 'FAIL';
                    else delete t.log[date];
                }
                return t;
            });
            render();
            await db.collection('users').doc(userId).set({ tasks }, { merge: true });
        }

        function render() {
            const viewDate = document.getElementById('viewDateSelector').value;
            const list = document.getElementById('taskList'); list.innerHTML = '';
            const pen = document.getElementById('holdingPen'); pen.innerHTML = '';
            let totalRep = 0;

            tasks.forEach(t => {
                const { score, currentStreak } = calculateStats(t);
                totalRep += score;
                
                const status = t.log ? t.log[viewDate] : null;
                const isActive = t.isDaily || t.date === viewDate;

                const li = document.createElement('li');
                if (status === 'DONE') li.className = 'state-done';
                if (status === 'FAIL') li.className = 'state-failed';

                const statusIcon = status === 'DONE' ? 'âœ“' : (status === 'FAIL' ? 'âœ•' : '');
                const statusClass = status === 'DONE' ? 'done' : (status === 'FAIL' ? 'failed' : '');

                li.innerHTML = `
                    <div class="status-box ${statusClass}" onclick="cycleStatus(${t.id})">${statusIcon}</div>
                    <span class="task-text">${t.text}</span>
                    <span class="badge" style="background:#eee">PTS ${score.toFixed(1)}</span>
                    ${currentStreak > 0 ? `<span class="badge" style="background:#fff3cd">ðŸ”¥ ${currentStreak}</span>` : ''}
                `;

                if (isActive) list.appendChild(li);
                else pen.appendChild(li);
            });

            document.getElementById('globalScore').innerText = totalRep.toFixed(1);
        }
    </script>
</body>
</html>
