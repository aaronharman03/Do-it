<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputation: Calendar & Vault Edition</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --success: #28a745; --danger: #dc3545; --warning: #ffc107; --primary: #007bff; --gold: #ffd700; }
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background: #f0f2f5; color: #1a1a1a; }
        #auth-screen { background: white; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 50px;}
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .auth-btn { background: #000; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        #app-ui { display: none; }
        
        /* Dashboard */
        .dashboard { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; position: relative; border-bottom: 5px solid #ddd;}
        .logout-btn { position: absolute; top: 10px; right: 10px; font-size: 0.6rem; cursor: pointer; background: #eee; border: none; padding: 5px; border-radius: 4px; }
        .global-score { font-size: 3.2rem; font-weight: 900; margin: 5px 0; line-height: 1; text-align: center;}
        .label { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 5px; display: block; }
        
        /* Progress Bars */
        .bar-bg { width: 100%; height: 10px; background: #eee; border-radius: 4px; overflow: hidden; margin: 8px 0; position: relative; }
        #medalProgressBar { height: 100%; background: var(--gold); width: 0%; transition: width 0.6s ease; }
        #ghostMarker { position: absolute; top: 0; width: 3px; height: 100%; background: rgba(0,0,0,0.4); z-index: 2; transition: left 0.6s ease; }
        
        /* Calendar Nav */
        .calendar-nav { display: flex; align-items: center; justify-content: space-between; background: #fff; padding: 10px; border-radius: 12px; margin-bottom: 15px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .nav-btn { border:none; background:none; cursor:pointer; font-size: 1.2rem; padding: 0 10px; }
        .calendar-nav input { border: none; font-weight: bold; font-family: inherit; font-size: 1rem; cursor: pointer; text-align: center; }

        /* Tasks */
        .input-group { background: #fff; padding: 18px; border-radius: 16px; margin-bottom: 25px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; font-size: 16px; outline: none; box-sizing: border-box; }
        ul { list-style: none; padding: 0; }
        li { background: #fff; margin-bottom: 12px; padding: 14px; border-radius: 16px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; border-left: 6px solid #ccc; }
        li.done { opacity: 0.6; }
        li.done .task-text { text-decoration: line-through; }
        li.pos-task { border-left-color: var(--success); }
        li.neg-task { border-left-color: var(--danger); }
        input[type="checkbox"] { width: 24px; height: 24px; margin-right: 12px; cursor: pointer; }
        .task-text { flex: 1; font-weight: 600; }
        .badge { font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; margin-left: 5px; white-space: nowrap; }
        .danger-badge { background: #ff4444; color: white; animation: pulse 1s infinite; }
        @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }
        
        .menu-dots { cursor: pointer; padding: 5px; font-size: 1.2rem; color: #ccc; }
        .menu-content { display: none; position: absolute; right: 0; top: 100%; background: white; border-radius: 8px; box-shadow: 0 5px 15px rgba(0,0,0,0.1); z-index: 100; min-width: 100px; }
        .menu-content.show { display: block; }
        .menu-content button { display: block; width: 100%; padding: 10px; border: none; background: none; text-align: left; cursor: pointer; font-size: 12px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <span class="label">Cloud Vault Access</span>
        <input type="email" id="email" class="auth-input" placeholder="Email">
        <input type="password" id="password" class="auth-input" placeholder="Password">
        <button onclick="handleAuth('login')" class="auth-btn" style="margin-bottom: 10px;">Login</button>
        <button onclick="handleAuth('signup')" class="auth-btn" style="background: #666;">Create Account</button>
    </div>

    <div id="app-ui">
        <div class="dashboard">
            <button class="logout-btn" onclick="logout()">LOGOUT</button>
            <div style="display: flex; justify-content: space-between; align-items: center;">
                <span class="label">Reputation</span>
                <span class="label">PB: <span id="pbScore" style="color:var(--gold)">0.0</span></span>
            </div>
            <div class="global-score" id="globalScore">0.0</div>
            <div class="bar-bg">
                <div id="medalProgressBar"></div>
                <div id="ghostMarker"></div>
            </div>
            <span class="label" id="nextMedalLabel">Next: Bronze (10)</span>
            <div style="display: flex; justify-content: space-around; margin-top: 10px;">
                <span id="m1">ü•â</span> <span id="m2">ü•à</span> <span id="m3">ü•á</span> <span id="m4">üëë</span>
            </div>
        </div>

        <div class="calendar-nav">
            <button onclick="changeViewDate(-1)" class="nav-btn">‚óÄ</button>
            <input type="date" id="viewDateSelector" onchange="render()">
            <button onclick="changeViewDate(1)" class="nav-btn">‚ñ∂</button>
        </div>

        <div class="input-group">
            <input type="text" id="taskInput" placeholder="New Mission..." autocomplete="off">
            <div style="display: flex; gap: 10px; margin-top: 12px; align-items: center;">
                <label style="font-size: 12px; font-weight: 700;"><input type="checkbox" id="dailyInput"> DAILY</label>
                <button id="addBtn" onclick="addTask()" style="margin-left: auto; background:#000; color:#fff; border:none; padding:10px 20px; border-radius:8px; font-weight: 800;">ADD</button>
            </div>
        </div>

        <span class="label">‚òÄÔ∏è Active for Selected Day</span>
        <ul id="taskList"></ul>
        <span class="label">üóìÔ∏è Holding Pen (One-offs)</span>
        <ul id="holdingPen"></ul>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBVKXdqta9WYvdz8g3j0ZKd_HYM-R1EJdo",
            authDomain: "do-it-685b9.firebaseapp.com",
            projectId: "do-it-685b9",
            storageBucket: "do-it-685b9.firebasestorage.app",
            messagingSenderId: "344979931866",
            appId: "1:344979931866:web:0b2e5cd04e883f33cfdbe3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let tasks = [], userId = null, yesterdayScore = 0, personalBest = 0;
        const getToday = () => new Date().toISOString().split('T')[0];
        document.getElementById('viewDateSelector').value = getToday();

        auth.onAuthStateChanged(async (user) => {
            if (user) { 
                userId = user.uid; 
                document.getElementById('auth-screen').style.display = 'none'; 
                document.getElementById('app-ui').style.display = 'block'; 
                await syncWithCloud(); 
            } else {
                userId = null;
                document.getElementById('auth-screen').style.display = 'block';
                document.getElementById('app-ui').style.display = 'none';
            }
        });

        async function handleAuth(type) {
            const e = document.getElementById('email').value, p = document.getElementById('password').value;
            try { type === 'signup' ? await auth.createUserWithEmailAndPassword(e, p) : await auth.signInWithEmailAndPassword(e, p); }
            catch (err) { alert(err.message); }
        }

        function logout() { auth.signOut(); }

        async function syncWithCloud() {
            if (!userId) return;
            const doc = await db.collection('users').doc(userId).get();
            if (doc.exists) {
                const data = doc.data();
                tasks = data.tasks || [];
                personalBest = data.personalBest || 0;
                yesterdayScore = data.yesterdayScore || 0;
                const today = getToday();
                if (data.lastLoginDate !== today) {
                    yesterdayScore = parseFloat(tasks.reduce((acc, t) => acc + (t.individualScore || 0), 0).toFixed(1));
                    await db.collection('users').doc(userId).set({ yesterdayScore, lastLoginDate: today }, { merge: true });
                }
            }
            render();
        }

        async function saveToCloud() {
            if (!userId) return;
            const currentTotal = parseFloat(tasks.reduce((acc, t) => acc + (t.individualScore || 0), 0).toFixed(1));
            if (currentTotal > personalBest) personalBest = currentTotal;
            try {
                await db.collection('users').doc(userId).set({ tasks, personalBest, yesterdayScore }, { merge: true });
            } catch (e) { console.error("Save Error", e); }
        }

        function changeViewDate(days) {
            const current = new Date(document.getElementById('viewDateSelector').value);
            current.setDate(current.getDate() + days);
            document.getElementById('viewDateSelector').value = current.toISOString().split('T')[0];
            render();
        }

        async function addTask() {
            const input = document.getElementById('taskInput'), daily = document.getElementById('dailyInput');
            if (!input.value.trim()) return;
            tasks.push({
                id: Date.now(), text: input.value.trim(), date: document.getElementById('viewDateSelector').value,
                isDaily: daily.checked, individualScore: 0, streak: 0,
                completedDates: [], penalizedDates: [], missedHistory: []
            });
            input.value = ''; daily.checked = false;
            render(); await saveToCloud();
        }

        async function toggleTask(id) {
            const targetDate = document.getElementById('viewDateSelector').value;
            tasks = tasks.map(t => {
                if (t.id === id) {
                    if (!t.completedDates) t.completedDates = [];
                    if (t.completedDates.includes(targetDate)) {
                        t.completedDates = t.completedDates.filter(d => d !== targetDate);
                        t.individualScore -= 1;
                        if(t.isDaily) t.streak = Math.max(0, t.streak - 1);
                    } else {
                        t.completedDates.push(targetDate);
                        t.individualScore += 1;
                        if(t.isDaily) t.streak++;
                        t.penalizedDates = (t.penalizedDates || []).filter(d => d !== targetDate);
                        t.missedHistory = (t.missedHistory || []).filter(d => d !== targetDate);
                    }
                }
                return t;
            });
            render(); await saveToCloud();
        }

        async function deleteTask(id) {
            if(confirm("Delete mission?")) { tasks = tasks.filter(t => t.id !== id); render(); await saveToCloud(); }
        }

        function toggleMenu(id) {
            event.stopPropagation();
            const el = document.getElementById(`menu-${id}`);
            document.querySelectorAll('.menu-content').forEach(m => m !== el && m.classList.remove('show'));
            el.classList.toggle('show');
        }

        window.onclick = () => document.querySelectorAll('.menu-content').forEach(m => m.classList.remove('show'));

        function render() {
            const viewDate = document.getElementById('viewDateSelector').value;
            const today = getToday();
            let stateChanged = false;

            // Penalty Engine
            tasks = tasks.map(t => {
                const lastLog = (t.completedDates && t.completedDates.length) ? t.completedDates.sort().reverse()[0] : t.date;
                if (lastLog < today && (t.isDaily || t.date === today) && !t.penalizedDates.includes(today) && !t.completedDates.includes(today)) {
                    let penalty = t.streak >= 30 ? 20 : (t.streak >= 10 ? 5 : 1);
                    t.individualScore -= penalty;
                    if(!t.missedHistory) t.missedHistory = [];
                    t.missedHistory.push(today);
                    
                    let major = false;
                    const h = t.missedHistory;
                    if (h.length >= 2) {
                        const d = Math.ceil(Math.abs(new Date(h[h.length-1]) - new Date(h[h.length-2])) / 86400000);
                        if (d === 1) major = true;
                    }
                    const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
                    if (!major && h.filter(x => new Date(x) >= weekAgo).length >= 3) major = true;
                    if (major) t.individualScore -= 10;

                    t.streak = 0;
                    t.penalizedDates.push(today);
                    stateChanged = true;
                }
                return t;
            });

            if (stateChanged) saveToCloud();

            const total = parseFloat(tasks.reduce((acc, t) => acc + (t.individualScore || 0), 0).toFixed(1));
            document.getElementById('globalScore').innerText = total.toFixed(1);
            document.getElementById('pbScore').innerText = personalBest.toFixed(1);

            const milestones = [{id:'m1', val:50}, {id:'m2', val:150}, {id:'m3', val:300}, {id:'m4', val:500}];
            let next = milestones.find(m => total < m.val) || {val: total}, prev = 0;
            milestones.forEach(m => { 
                const el = document.getElementById(m.id);
                if (total >= m.val) { el.style.filter = "grayscale(0)"; el.style.opacity = "1"; prev = m.val; }
                else { el.style.filter = "grayscale(1)"; el.style.opacity = "0.2"; }
            });
            document.getElementById('medalProgressBar').style.width = Math.max(0, ((total - prev) / (next.val - prev)) * 100) + "%";

            // Ghost Marker
            const ghost = document.getElementById('ghostMarker');
            let gPrev = 0; milestones.forEach(m => { if (yesterdayScore >= m.val) gPrev = m.val; });
            let gNext = milestones.find(m => yesterdayScore < m.val) || {val: yesterdayScore};
            ghost.style.left = Math.max(0, ((yesterdayScore - gPrev) / (gNext.val - gPrev)) * 100) + "%";

            const list = document.getElementById('taskList'); 
            const pen = document.getElementById('holdingPen');
            list.innerHTML = ''; pen.innerHTML = '';

            tasks.sort((a,b) => new Date(a.date) - new Date(b.date)).forEach(t => {
                const isActive = t.isDaily || t.date === viewDate;
                const isDone = (t.completedDates || []).includes(viewDate);
                const weekAgo = new Date(); weekAgo.setDate(weekAgo.getDate() - 7);
                const risk = (t.missedHistory || []).filter(d => new Date(d) >= weekAgo).length >= 2;

                const li = document.createElement('li');
                if (isDone) li.classList.add('done');
                li.classList.add(t.individualScore >= 0 ? 'pos-task' : 'neg-task');

                li.innerHTML = `
                    <input type="checkbox" ${isDone ? 'checked' : ''} onchange="toggleTask(${t.id})">
                    <span class="task-text">${t.text}</span>
                    ${risk && !isDone && viewDate === today ? '<span class="badge danger-badge">‚ö†Ô∏è RISK</span>' : ''}
                    <span class="badge" style="background:#eee">PTS ${t.individualScore.toFixed(1)}</span>
                    ${t.streak > 0 ? `<span class="badge" style="background:#fff3cd">üî• ${t.streak}</span>` : ''}
                    <div class="menu-dots" onclick="toggleMenu(${t.id})">‚ãÆ</div>
                    <div class="menu-content" id="menu-${t.id}">
                        <button onclick="deleteTask(${t.id})" style="color:var(--danger)">DELETE</button>
                    </div>
                `;
                
                if (isActive) list.appendChild(li);
                else if (!t.isDaily && t.date > viewDate) pen.appendChild(li);
            });
        }
    </script>
</body>
</html>
