<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputation Todo: Milestone Edition</title>
    <style>
        :root { --success: #28a745; --danger: #dc3545; --warning: #ffc107; --primary: #007bff; --gold: #ffd700; }
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background: #f0f2f5; color: #1a1a1a; }
        
        .dashboard { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; text-align: center; border-bottom: 5px solid #ddd; }
        .global-score { font-size: 3rem; font-weight: 900; margin: 5px 0; }
        .label { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1.5px; font-weight: 700; }
        
        .bar-bg { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 10px 0; }
        #progressBar { height: 100%; background: var(--success); width: 0%; transition: width 0.6s ease; }

        /* Milestones Styling */
        .milestones { display: flex; justify-content: space-around; margin-bottom: 20px; background: white; padding: 15px; border-radius: 16px; box-shadow: 0 4px 10px rgba(0,0,0,0.03); }
        .medal { font-size: 1.5rem; filter: grayscale(1); opacity: 0.3; transition: all 0.5s ease; position: relative; }
        .medal.unlocked { filter: grayscale(0); opacity: 1; transform: scale(1.2); }
        .medal.unlocked::after { content: '‚ú®'; position: absolute; top: -10px; right: -10px; font-size: 0.8rem; }

        .input-group { background: #fff; padding: 18px; border-radius: 16px; margin-bottom: 25px; box-shadow: 0 4px 12px rgba(0,0,0,0.03); }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; font-size: 16px; outline: none; box-sizing: border-box; }
        .controls { display: flex; gap: 10px; margin-top: 12px; align-items: center; }
        input[type="date"] { flex: 1; border: 1px solid #eee; border-radius: 8px; padding: 8px; font-size: 16px; }
        button#addBtn { background: #000; color: #fff; border: none; border-radius: 8px; padding: 10px 20px; font-weight: 800; cursor: pointer; font-size: 16px; }

        ul { list-style: none; padding: 0; }
        li { background: #fff; margin-bottom: 12px; padding: 14px; border-radius: 16px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); transition: 0.3s; }
        
        #todayList li { border-left: 6px solid #ccc; }
        #todayList li.pos-task { border-left-color: var(--success); background: #fafffb; }
        #todayList li.neg-task { border-left-color: var(--danger); background: #fff5f5; }
        #todayList li.done { opacity: 0.6; }
        #todayList li.done .task-text { text-decoration: line-through; }
        #upcomingList li { border-left: 6px solid #ddd; background: #fafafa; color: #666; }

        input[type="checkbox"] { width: 24px; height: 24px; margin-right: 12px; cursor: pointer; accent-color: #000; }
        .min-effort-btn { background: #fff3cd; border: 1px solid #ffeeba; color: #856404; border-radius: 50%; width: 30px; height: 30px; font-size: 16px; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 12px; flex-shrink: 0; }
        .task-text { flex: 1; font-weight: 600; font-size: 16px; }
        .badge { font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; margin-left: 5px; white-space: nowrap; }
        .score-badge { background: #f0f2f5; color: #444; }
        .streak-badge { background: #fff3cd; color: #856404; }
        .promo-btn { background: #eef; color: var(--primary); border: 1px solid #ccf; padding: 4px 8px; border-radius: 6px; font-size: 12px; font-weight: bold; cursor: pointer; margin-left: 10px; }
        .del-btn { margin-left: 10px; color: #ddd; cursor: pointer; border: none; background: none; font-size: 1.2rem; }
    </style>
</head>
<body>

    <div class="dashboard">
        <div class="label">Reputation Score</div>
        <div class="global-score" id="globalScore">0.0</div>
        
        <div class="milestones">
            <div class="medal" id="m1" title="10 Points: The Spark">ü•â</div>
            <div class="medal" id="m2" title="50 Points: Habitual">ü•à</div>
            <div class="medal" id="m3" title="100 Points: Unstoppable">ü•á</div>
            <div class="medal" id="m4" title="500 Points: The Legend">üëë</div>
        </div>

        <div class="bar-bg"><div id="progressBar"></div></div>
        <div class="label" id="progressText" style="font-size: 0.6rem;">0% TODAY</div>
    </div>

    <div class="input-group">
        <input type="text" id="taskInput" placeholder="New thought or mission..." autocomplete="off">
        <div class="controls">
            <input type="date" id="dateInput">
            <label style="font-size: 13px; font-weight: 700; cursor: pointer;"><input type="checkbox" id="dailyInput"> DAILY</label>
            <button id="addBtn" onclick="addTask()">ADD</button>
        </div>
    </div>

    <h2 class="label">‚òÄÔ∏è Active Today</h2>
    <ul id="todayList"></ul>

    <h2 class="label">üóìÔ∏è Holding Pen</h2>
    <ul id="upcomingList"></ul>

    <script>
        let tasks = JSON.parse(localStorage.getItem('final_v3_todos')) || [];
        const getToday = () => new Date().toISOString().split('T')[0];

        function addTask() {
            const input = document.getElementById('taskInput');
            const dateInput = document.getElementById('dateInput');
            const dailyInput = document.getElementById('dailyInput');
            if (!input.value.trim()) return;

            tasks.push({
                id: Date.now(),
                text: input.value.trim(),
                date: dateInput.value,
                isDaily: dailyInput.checked,
                done: false,
                individualScore: 0,
                streak: 0,
                lastCompletedDate: null,
                penalizedDates: [] 
            });

            input.value = ''; dateInput.value = ''; dailyInput.checked = false;
            render();
        }

        function promoteTask(id) {
            tasks = tasks.map(t => t.id === id ? { ...t, date: getToday() } : t);
            render();
        }

        function complete(id, type) {
            tasks = tasks.map(t => {
                if (t.id === id) {
                    if (t.done) return t; 
                    t.done = true;
                    t.lastCompletedDate = getToday();
                    if (type === 'FULL') {
                        t.individualScore += 1;
                        if (t.isDaily) t.streak += 1;
                    } else if (type === 'MINIMAL') {
                        t.individualScore += 0.1;
                    }
                }
                return t;
            });
            render();
        }

        function render() {
            const today = getToday();
            
            tasks = tasks.map(t => {
                const isTodayActive = (t.isDaily || t.date === today);
                if (t.isDaily && t.lastCompletedDate !== today) t.done = false;

                let deadline = t.isDaily ? (t.lastCompletedDate || t.date) : t.date;
                if (deadline && deadline < today && isTodayActive && !t.done) {
                    if (!t.penalizedDates.includes(today)) {
                        t.individualScore -= 1;
                        t.streak = 0;
                        t.penalizedDates.push(today);
                    }
                }
                return t;
            });

            localStorage.setItem('final_v3_todos', JSON.stringify(tasks));

            const totalScore = parseFloat(tasks.reduce((acc, t) => acc + t.individualScore, 0).toFixed(1));
            document.getElementById('globalScore').innerText = totalScore.toFixed(1);
            document.getElementById('globalScore').style.color = totalScore >= 0 ? "var(--success)" : "var(--danger)";

            // Milestone Logic
            if (totalScore >= 10) document.getElementById('m1').classList.add('unlocked');
            if (totalScore >= 50) document.getElementById('m2').classList.add('unlocked');
            if (totalScore >= 100) document.getElementById('m3').classList.add('unlocked');
            if (totalScore >= 500) document.getElementById('m4').classList.add('unlocked');

            const tList = document.getElementById('todayList');
            const uList = document.getElementById('upcomingList');
            tList.innerHTML = ''; uList.innerHTML = '';

            const activeTodayTasks = tasks.filter(t => t.isDaily || t.date === today);
            const doneToday = activeTodayTasks.filter(t => t.done).length;
            const percent = activeTodayTasks.length ? Math.round((doneToday / activeTodayTasks.length) * 100) : 0;
            document.getElementById('progressBar').style.width = percent + "%";
            document.getElementById('progressText').innerText = percent + "% TODAY";

            tasks.forEach(t => {
                const li = document.createElement('li');
                const isTodayActive = (t.isDaily || t.date === today);

                if (isTodayActive) {
                    if (t.done) li.classList.add('done');
                    if (t.individualScore > 0) li.classList.add('pos-task');
                    else if (t.individualScore < 0) li.classList.add('neg-task');

                    li.innerHTML = `
                        <input type="checkbox" ${t.done ? 'checked disabled' : ''} onchange="complete(${t.id}, 'FULL')">
                        ${!t.done ? `<div class="min-effort-btn" onclick="complete(${t.id}, 'MINIMAL')">‚ö°</div>` : ''}
                        <span class="task-text">${t.text}</span>
                        <span class="badge score-badge">PTS ${t.individualScore.toFixed(1)}</span>
                        ${t.streak > 0 ? `<span class="badge streak-badge">üî• ${t.streak}</span>` : ''}
                        <button class="del-btn" onclick="deleteTask(${t.id})">‚úï</button>
                    `;
                    tList.appendChild(li);
                } else {
                    li.innerHTML = `
                        <span class="task-text">${t.text} ${t.date ? `<small>(${t.date})</small>` : ''}</span>
                        <button class="promo-btn" onclick="promoteTask(${t.id})">‚òÄÔ∏è Today</button>
                        <button class="del-btn" onclick="deleteTask(${t.id})">‚úï</button>
                    `;
                    uList.appendChild(li);
                }
            });
        }

        function deleteTask(id) {
            if(confirm("Delete task? Score history stays.")) {
                tasks = tasks.filter(t => t.id !== id);
                render();
            }
        }

        document.getElementById('taskInput').addEventListener('keypress', (e) => { if(e.key === 'Enter') addTask(); });
        render();
    </script>
</body>
</html>
