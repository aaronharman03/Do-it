<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Todo</title>
    <link rel="manifest" href="manifest.json">
    <style>
        :root { --primary: #007bff; --bg: #f8f9fa; --text: #212529; }
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background: var(--bg); color: var(--text); }
        
        .input-group { background: white; padding: 16px; border-radius: 16px; box-shadow: 0 4px 12px rgba(0,0,0,0.08); margin-bottom: 24px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 8px; font-size: 16px; outline: none; box-sizing: border-box; }
        
        .controls { display: flex; gap: 10px; margin-top: 10px; align-items: center; }
        input[type="date"] { flex: 1; border: 1px solid #eee; border-radius: 8px; padding: 8px; font-size: 16px; }
        .daily-label { font-size: 14px; color: #666; display: flex; align-items: center; gap: 5px; cursor: pointer; }
        button#addBtn { background: var(--primary); color: white; border: none; border-radius: 8px; padding: 10px 15px; font-weight: 600; cursor: pointer; font-size: 16px; }

        h2 { font-size: 0.85rem; text-transform: uppercase; letter-spacing: 1px; color: #888; margin: 32px 0 12px 4px; }
        ul { list-style: none; padding: 0; margin: 0; }
        li { background: white; margin-bottom: 8px; padding: 14px; border-radius: 12px; display: flex; align-items: center; box-shadow: 0 2px 4px rgba(0,0,0,0.03); }
        
        input[type="checkbox"] { width: 22px; height: 22px; margin-right: 14px; cursor: pointer; accent-color: var(--primary); }
        .task-text { flex: 1; font-size: 16px; }
        li.done { opacity: 0.5; }
        li.done .task-text { text-decoration: line-through; }
        
        .tag { font-size: 0.7rem; font-weight: 700; padding: 2px 8px; border-radius: 4px; margin-left: 8px; }
        .daily-tag { background: #e7f3ff; color: var(--primary); }
        .date-tag { background: #eee; color: #777; }
        .del-btn { color: #ffbcbc; border: none; background: none; font-size: 1.4rem; cursor: pointer; padding-left: 10px; }
    </style>
</head>
<body>

    <div class="input-group">
        <input type="text" id="taskInput" placeholder="What's next?" autocomplete="off">
        <div class="controls">
            <input type="date" id="dateInput">
            <label class="daily-label"><input type="checkbox" id="dailyInput"> Daily</label>
            <button id="addBtn" onclick="addTask()">Add</button>
        </div>
    </div>

    <h2>‚òÄÔ∏è Today</h2>
    <ul id="todayList"></ul>

    <h2>üóìÔ∏è Upcoming</h2>
    <ul id="upcomingList"></ul>

    <script>
        if ('serviceWorker' in navigator) { navigator.serviceWorker.register('sw.js').catch(()=>{}); }

        let tasks = JSON.parse(localStorage.getItem('todo_pwa_tasks')) || [];
        const getTodayStr = () => new Date().toISOString().split('T')[0];

        document.getElementById('taskInput').addEventListener('keypress', (e) => {
            if (e.key === 'Enter') addTask();
        });

        function addTask() {
            const input = document.getElementById('taskInput');
            const dateInput = document.getElementById('dateInput');
            const dailyInput = document.getElementById('dailyInput');
            if (!input.value.trim()) return;

            tasks.push({
                id: Date.now(),
                text: input.value.trim(),
                date: dateInput.value,
                isDaily: dailyInput.checked,
                done: false,
                lastCompleted: null
            });

            input.value = ''; dateInput.value = ''; dailyInput.checked = false;
            render();
        }

        function toggle(id) {
            tasks = tasks.map(t => {
                if (t.id === id) {
                    const isDone = !t.done;
                    return { ...t, done: isDone, lastCompleted: isDone ? getTodayStr() : null };
                }
                return t;
            });
            render();
        }

        function deleteTask(id) {
            tasks = tasks.filter(t => t.id !== id);
            render();
        }

        function render() {
            const todayStr = getTodayStr();
            
            // Recurrence Logic: Reset daily tasks if today is a new day
            tasks = tasks.map(t => {
                if (t.isDaily && t.lastCompleted !== todayStr) {
                    return { ...t, done: false };
                }
                return t;
            });

            tasks.sort((a, b) => (a.date > b.date) ? 1 : -1);
            localStorage.setItem('todo_pwa_tasks', JSON.stringify(tasks));

            const tList = document.getElementById('todayList');
            const uList = document.getElementById('upcomingList');
            tList.innerHTML = ''; uList.innerHTML = '';

            tasks.forEach(t => {
                const li = document.createElement('li');
                if (t.done) li.classList.add('done');
                
                const tag = t.isDaily ? `<span class="tag daily-tag">DAILY</span>` : 
                            t.date ? `<span class="tag date-tag">${t.date === todayStr ? 'Today' : t.date}</span>` : '';

                li.innerHTML = `
                    <input type="checkbox" ${t.done ? 'checked' : ''} onclick="toggle(${t.id})">
                    <span class="task-text">${t.text}</span>
                    ${tag}
                    <button class="del-btn" onclick="deleteTask(${t.id})">‚úï</button>
                `;

                (t.isDaily || t.date === todayStr || !t.date) ? tList.appendChild(li) : uList.appendChild(li);
            });
        }
        render();
    </script>
</body>
</html>
