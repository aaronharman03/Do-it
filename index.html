<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Reputation: Ghost Ledger</title>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-auth-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore-compat.js"></script>
    <style>
        :root { --success: #28a745; --danger: #dc3545; --warning: #ffc107; --primary: #007bff; --gold: #ffd700; --boss: #6f42c1; }
        body { font-family: -apple-system, system-ui, sans-serif; max-width: 500px; margin: 0 auto; padding: 20px; background: #f0f2f5; color: #1a1a1a; }
        #auth-screen { background: white; padding: 30px; border-radius: 20px; text-align: center; box-shadow: 0 10px 25px rgba(0,0,0,0.1); margin-top: 50px;}
        .auth-input { width: 100%; padding: 12px; margin: 10px 0; border: 1px solid #ddd; border-radius: 8px; box-sizing: border-box; font-size: 16px; }
        .auth-btn { background: #000; color: white; border: none; padding: 12px 20px; border-radius: 8px; cursor: pointer; width: 100%; font-weight: bold; }
        #app-ui { display: none; }
        
        .dashboard { background: #fff; padding: 20px; border-radius: 20px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); margin-bottom: 25px; border-bottom: 5px solid #ddd; position: relative; }
        .global-score { font-size: 3rem; font-weight: 900; line-height: 1; }
        .high-score { font-size: 1.5rem; font-weight: 900; color: var(--gold); }
        .label { font-size: 0.7rem; text-transform: uppercase; color: #888; letter-spacing: 1.5px; font-weight: 700; margin-bottom: 5px; display: block; }
        
        .bar-bg { width: 100%; height: 10px; background: #eee; border-radius: 5px; overflow: hidden; margin: 10px 0; position: relative; }
        #medalProgressBar { height: 100%; background: var(--gold); width: 0%; transition: width 0.6s ease; }
        #ghostMarker { position: absolute; top: 0; width: 3px; height: 100%; background: rgba(0,0,0,0.4); z-index: 5; transition: left 0.6s ease; }

        .calendar-nav { display: flex; align-items: center; justify-content: center; gap: 15px; margin-bottom: 20px; background: white; padding: 10px; border-radius: 12px; }
        .nav-btn { border: none; background: none; font-size: 1.2rem; cursor: pointer; padding: 5px; }
        #viewDateSelector { border: none; font-weight: bold; font-size: 16px; font-family: inherit; cursor: pointer; text-align: center; }
        
        .input-group { background: #fff; padding: 18px; border-radius: 16px; margin-bottom: 25px; }
        input[type="text"] { width: 100%; padding: 12px; border: 1px solid #eee; border-radius: 10px; font-size: 16px; outline: none; box-sizing: border-box; }
        .controls { display: flex; gap: 10px; margin-top: 12px; align-items: center; flex-wrap: wrap; }
        input[type="date"], input[type="number"] { border: 1px solid #eee; border-radius: 8px; padding: 8px; font-size: 14px; }
        input[type="number"] { width: 60px; }
        
        ul { list-style: none; padding: 0; }
        li { background: #fff; margin-bottom: 12px; padding: 14px; border-radius: 16px; display: flex; align-items: center; box-shadow: 0 2px 8px rgba(0,0,0,0.04); position: relative; border-left: 6px solid #ccc; transition: 0.3s; }
        
        li.boss-mode { background: #1a1a1a; color: white; border-left-color: var(--boss); animation: shadow-pulse 2s infinite; }
        @keyframes shadow-pulse { 0% { box-shadow: 0 0 5px rgba(111, 66, 193, 0.2); } 50% { box-shadow: 0 0 15px rgba(111, 66, 193, 0.6); } 100% { box-shadow: 0 0 5px rgba(111, 66, 193, 0.2); } }

        li.state-done { border-left-color: var(--success); }
        li.state-failed { border-left-color: var(--danger); }
        li.state-done.boss-mode { border-left-color: var(--gold); }
        li.state-done .task-text { text-decoration: line-through; opacity: 0.5; }

        .status-box { width: 34px; height: 34px; border-radius: 8px; border: 2px solid #ddd; display: flex; align-items: center; justify-content: center; cursor: pointer; margin-right: 12px; font-size: 18px; font-weight: bold; background: white; flex-shrink: 0; color: #333; }
        .status-box.done { background: var(--success); border-color: var(--success); color: white; }
        .status-box.failed { background: var(--danger); border-color: var(--danger); color: white; }

        .task-text { flex: 1; font-weight: 600; font-size: 16px; cursor: pointer; }
        .badge { font-size: 0.7rem; font-weight: 800; padding: 4px 8px; border-radius: 6px; margin-left: 5px; white-space: nowrap; color: #333; }
        .order-tag { font-size: 0.6rem; color: #aaa; margin-right: 8px; font-weight: bold; }
    </style>
</head>
<body>

    <div id="auth-screen">
        <input type="email" id="email" class="auth-input" placeholder="Email">
        <input type="password" id="password" class="auth-input" placeholder="Password">
        <button onclick="handleAuth('login')" class="auth-btn">Access Ledger</button>
    </div>

    <div id="app-ui">
        <div class="dashboard">
            <div style="display: flex; justify-content: space-around; text-align: center;">
                <div><span class="label">Reputation</span><div class="global-score" id="globalScore">0.0</div></div>
                <div><span class="label">High Score</span><div class="high-score" id="highScore">0.0</div></div>
            </div>
            
            <div class="bar-bg">
                <div id="medalProgressBar"></div>
                <div id="ghostMarker"></div>
            </div>
            <span class="label" id="nextMedalLabel" style="font-size: 0.55rem; text-align: center;">Next Medal</span>

            <div style="display: flex; justify-content: space-around; margin-top: 5px; font-size: 1.2rem;">
                <span id="m1" style="opacity:0.2">ü•â</span><span id="m2" style="opacity:0.2">ü•à</span>
                <span id="m3" style="opacity:0.2">ü•á</span><span id="m4" style="opacity:0.2">üëë</span>
            </div>
        </div>

        <div class="calendar-nav">
            <button class="nav-btn" onclick="changeViewDate(-1)">‚óÄ</button>
            <input type="date" id="viewDateSelector" onchange="render()">
            <button class="nav-btn" onclick="changeViewDate(1)">‚ñ∂</button>
        </div>

        <div class="input-group">
            <input type="text" id="taskInput" placeholder="New mission...">
            <div class="controls">
                <input type="date" id="dateInput">
                <input type="number" id="orderInput" placeholder="Pos" title="Task Order Number">
                <label style="font-size: 12px; font-weight: 700;"><input type="checkbox" id="dailyInput"> DAILY</label>
                <button onclick="addTask()" id="addBtn" style="margin-left: auto; background: black; color: white; border: none; padding: 10px 20px; border-radius: 8px; font-weight: 800; cursor: pointer;">ADD</button>
            </div>
        </div>

        <ul id="taskList"></ul>
        <span class="label">üóìÔ∏è Holding Pen</span>
        <ul id="holdingPen"></ul>
    </div>

    <script>
        const firebaseConfig = {
            apiKey: "AIzaSyBVKXdqta9WYvdz8g3j0ZKd_HYM-R1EJdo",
            authDomain: "do-it-685b9.firebaseapp.com",
            projectId: "do-it-685b9",
            storageBucket: "do-it-685b9.firebasestorage.app",
            messagingSenderId: "344979931866",
            appId: "1:344979931866:web:0b2e5cd04e883f33cfdbe3"
        };
        firebase.initializeApp(firebaseConfig);
        const auth = firebase.auth();
        const db = firebase.firestore();

        let tasks = [], userId = null, highScore = 0, ghostScore = 0, editingId = null;
        const getToday = () => new Date().toISOString().split('T')[0];
        document.getElementById('viewDateSelector').value = getToday();

        auth.onAuthStateChanged(async (u) => { if(u){ userId=u.uid; document.getElementById('auth-screen').style.display='none'; document.getElementById('app-ui').style.display='block'; await sync(); } });
        async function handleAuth(t){ const e=document.getElementById('email').value, p=document.getElementById('password').value; await auth.signInWithEmailAndPassword(e,p).catch(err=>alert(err)); }
        
        async function sync(){ 
            const doc = await db.collection('users').doc(userId).get(); 
            if(doc.exists){ 
                const d = doc.data(); 
                tasks = d.tasks || []; 
                highScore = d.highScore || 0; 
                ghostScore = d.ghostScore || 0;
                if(d.lastLoginDate !== getToday()) {
                    ghostScore = parseFloat(tasks.reduce((acc, t) => acc + calculateStats(t).s, 0).toFixed(1));
                    await db.collection('users').doc(userId).set({ ghostScore, lastLoginDate: getToday() }, { merge: true });
                }
            } 
            render(); 
        }

        async function save(){ await db.collection('users').doc(userId).set({ tasks, highScore, ghostScore }, { merge: true }); }

        function changeViewDate(d){ const c=new Date(document.getElementById('viewDateSelector').value); c.setDate(c.getDate()+d); document.getElementById('viewDateSelector').value=c.toISOString().split('T')[0]; render(); }

        function addTask(){
            const i=document.getElementById('taskInput'), dIn=document.getElementById('dateInput'), dy=document.getElementById('dailyInput'), ord=document.getElementById('orderInput');
            if(!i.value) return;
            const orderVal = parseInt(ord.value) || 999;

            if(editingId){
                tasks=tasks.map(t=>t.id===editingId ? {...t, text:i.value, isDaily:dy.checked, order:orderVal} : t);
                editingId=null; document.getElementById('addBtn').innerText="ADD";
            } else {
                tasks.push({ id:Date.now(), text:i.value, date:dIn.value||getToday(), isDaily:dy.checked, order:orderVal, log:{} });
            }
            i.value=''; dIn.value=''; dy.checked=false; ord.value=''; render(); save();
        }

        function calculateStats(t) {
            let s=0, strk=0; const dts=Object.keys(t.log||{}).sort();
            dts.forEach((d,idx)=>{
                const st=t.log[d];
                if(st==='DONE'){
                    strk++;
                    s += 1; // Standard point
                    if (strk % 7 === 0) s += 10; // 7-day milestone
                    else if (strk === 3) s += 3; // 3-day milestone
                }
                else if(st==='FAIL'){
                    const boss=(strk+1)%7===0 && strk>0;
                    if(boss){ s-=50; } else { s-=(strk>=30?20:(strk>=10?5:1)); }
                    strk=0;
                    if(idx>0 && Math.ceil(Math.abs(new Date(d)-new Date(dts[idx-1]))/86400000)===1 && t.log[dts[idx-1]]==='FAIL') s-=10;
                    const wAgo=new Date(d); wAgo.setDate(wAgo.getDate()-7);
                    if(dts.filter(dt=>new Date(dt)<=new Date(d) && new Date(dt)>wAgo && t.log[dt]==='FAIL').length===3) s-=10;
                }
            });
            return { s, strk };
        }

        function cycleStatus(id){
            const date=document.getElementById('viewDateSelector').value;
            tasks=tasks.map(t=>{ if(t.id===id){ t.log=t.log||{}; const c=t.log[date]; if(!c)t.log[date]='DONE'; else if(c==='DONE')t.log[date]='FAIL'; else delete t.log[date]; } return t; });
            render(); save();
        }

        function editTask(id){ 
            const t=tasks.find(x=>x.id===id); editingId=id; 
            document.getElementById('taskInput').value=t.text; 
            document.getElementById('dailyInput').checked=t.isDaily;
            document.getElementById('orderInput').value=t.order || '';
            document.getElementById('addBtn').innerText="SAVE"; 
            window.scrollTo(0,0);
        }

        function render(){
            const vD=document.getElementById('viewDateSelector').value, tL=document.getElementById('taskList'), hP=document.getElementById('holdingPen');
            tL.innerHTML=''; hP.innerHTML=''; let totalRep = 0;

            // Sort by Order property, then by ID
            const sortedTasks = [...tasks].sort((a, b) => (a.order || 999) - (b.order || 999) || a.id - b.id);

            sortedTasks.forEach(t=>{
                const {s, strk}=calculateStats(t); totalRep+=s;
                const st=t.log?t.log[vD]:null, act=t.isDaily||t.date===vD, boss=(strk+1)%7===0 && strk>0 && !st;
                const li=document.createElement('li');
                const orderDisp = t.order && t.order !== 999 ? `<span class="order-tag">#${t.order}</span>` : '';

                if(act){
                    if(boss)li.classList.add('boss-mode'); if(st==='DONE')li.classList.add('state-done'); if(st==='FAIL')li.classList.add('state-failed');
                    li.innerHTML=`<div class="status-box ${st==='DONE'?'done':(st==='FAIL'?'failed':'')}" onclick="cycleStatus(${t.id})">${st==='DONE'?'‚úì':(st==='FAIL'?'‚úï':(boss?'üëπ':''))}</div>
                    <span class="task-text" onclick="editTask(${t.id})">${orderDisp}${boss?'BOSS: ':''}${t.text}</span>
                    <span class="badge">PTS ${s.toFixed(1)}</span>${strk>0?`<span class="badge" style="background:#fff3cd">üî• ${strk}</span>`:''}`;
                    tL.appendChild(li);
                } else {
                    li.innerHTML=`<span class="task-text" onclick="editTask(${t.id})">${orderDisp}${t.text} <small>(${t.date})</small></span>
                    <button class="nav-btn" onclick="tasks=tasks.map(x=>x.id===${t.id}?{...x,date:'${getToday()}'}:x);render();save();">‚òÄÔ∏è</button>`;
                    hP.appendChild(li);
                }
            });

            if(totalRep > highScore) highScore = totalRep;
            document.getElementById('globalScore').innerText = totalRep.toFixed(1);
            document.getElementById('highScore').innerText = highScore.toFixed(1);

            const m=[{id:'m1',v:50,n:'Bronze'},{id:'m2',v:150,n:'Silver'},{id:'m3',v:300,n:'Gold'},{id:'m4',v:500,n:'Legend'}];
            let n=m.find(x=>totalRep<x.v)||{v:totalRep,n:'Max'}, p=0;
            m.forEach(x=>{ const el=document.getElementById(x.id); if(totalRep>=x.v){ el.style.opacity="1"; p=x.v; }else el.style.opacity="0.2"; });
            
            const barWidth = Math.max(0,((totalRep-p)/(n.v-p))*100);
            document.getElementById('medalProgressBar').style.width = barWidth + "%";
            
            let gP = 0; m.forEach(x => { if(ghostScore >= x.v) gP = x.v; });
            let gN = m.find(x => ghostScore < x.v) || {v: ghostScore};
            const ghostPos = Math.max(0, ((ghostScore-gP)/(gN.v-gP))*100);
            document.getElementById('ghostMarker').style.left = ghostPos + "%";

            document.getElementById('nextMedalLabel').innerText=`Next: ${n.n} (${n.v.toFixed(1)} Pts)`;
        }
    </script>
</body>
</html>
